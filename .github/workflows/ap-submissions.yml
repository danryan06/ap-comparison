name: AP submissions from issues

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  process-ap-issue:
    # Only run for issues that match our form patterns
    if: |
      startsWith(github.event.issue.title, 'New AP:') ||
      startsWith(github.event.issue.title, 'Edit AP:')
    runs-on: ubuntu-latest

    permissions:
      contents: write        # needed to push branches / commits
      pull-requests: write   # needed to open PRs

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # Fetch full history for rebasing

      - name: List repo contents (debug)
        run: |
          pwd
          ls
          ls .github
          ls .github/scripts

      - name: Decide mode (new vs edit)
        id: mode
        run: |
          title="${{ github.event.issue.title }}"
          if [[ "$title" == New\ AP:* ]]; then
            echo "mode=new" >> $GITHUB_OUTPUT
          else
            echo "mode=edit" >> $GITHUB_OUTPUT
          fi

      - name: Ensure we're on latest main
        run: |
          git pull origin main --rebase || git pull origin main

      - name: Handle existing PR branch (prevent conflicts)
        id: branch-handler
        run: |
          BRANCH_NAME="ap-update/issue-${{ github.event.issue.number }}"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME exists"
            echo "branch-exists=true" >> $GITHUB_OUTPUT
            
            # Fetch the branch
            git fetch origin "$BRANCH_NAME"
            
            # Checkout the existing branch
            git checkout "$BRANCH_NAME"
            
            # Configure git for rebase
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Try to rebase onto latest main (this will be the base for new changes)
            if git rebase origin/main; then
              echo "Successfully rebased existing branch onto main"
              echo "rebase-success=true" >> $GITHUB_OUTPUT
              # Push the rebased branch so the action can update it
              git push origin "$BRANCH_NAME" --force-with-lease || true
            else
              echo "Rebase failed (likely due to conflicts), will continue from main"
              echo "rebase-success=false" >> $GITHUB_OUTPUT
              git rebase --abort || true
            fi
            
            # Return to main for applying new changes
            git checkout main
          else
            echo "Branch $BRANCH_NAME does not exist, will create new one"
            echo "branch-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Save issue body to file
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import os

          body = os.environ["ISSUE_BODY"]
          Path("issue_body.txt").write_text(body, encoding="utf-8")
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Apply issue to ap_data.json
        id: apply
        run: |
          python .github/scripts/apply_issue_to_ap_data.py \
            --mode "${{ steps.mode.outputs.mode }}" \
            --issue-number "${{ github.event.issue.number }}" \
            --input issue_body.txt \
            --data ap_data.json

      - name: Clean up temporary files
        run: |
          rm -f issue_body.txt

      - name: Create pull request with AP data changes
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "AP data update from issue #${{ github.event.issue.number }}"
          branch: "ap-update/issue-${{ github.event.issue.number }}"
          title: "AP data update: ${{ github.event.issue.title }}"
          body: |
            This PR was auto-generated from issue #${{ github.event.issue.number }}.

            Please review the AP data changes before merging.
          labels: |
            ap-submission
