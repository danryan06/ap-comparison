<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AP Feature Finder | Enterprise AP Comparison Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="header-with-logo">
      <h1><a href="index.html">Enterprise AP Comparison Database</a></h1>
      <img src="logo.png" alt="Enterprise AP Comparison Database" class="site-logo" />
    </div>
    <p class="subtitle">
      Design your deployment the way sizing tools do: pick your Wi-Fi generation, preferred vendors, and antenna style, then instantly see every AP that fits.
    </p>

    <div class="actions">
      <a class="btn-link" href="index.html">Back to Comparison Table</a>
      <a class="btn-link" href="submit.html">Submit New AP</a>
      <button id="clear-filters" type="button" class="btn-link">Reset Filters</button>
    </div>

    <div class="card finder-card">
      <div class="badge">New</div>
      <div class="finder-grid">
        <section class="filter-panel">
          <h2>Filters</h2>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Wi-Fi Generation</h3>
            </div>
            <div id="wifi-options" class="chip-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Vendor</h3>
            </div>
            <div id="vendor-options" class="chip-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Form Factor</h3>
            </div>
            <div id="form-options" class="chip-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Antenna Type</h3>
            </div>
            <div id="antenna-options" class="chip-grid"></div>
          </div>
        </section>

        <section class="results-panel">
          <div class="results-header">
            <div>
              <h2>Results</h2>
              <p class="results-note" id="results-note">Loading data…</p>
            </div>
            <div class="match-count" id="match-count">—</div>
          </div>

          <div id="active-filters" class="active-filters" style="display:none;"></div>

          <div id="results" class="results-table">
            <div class="result-row result-header">
              <div class="result-cell"></div>
              <div class="result-cell">Vendor</div>
              <div class="result-cell">Model</div>
              <div class="result-cell">Wi-Fi Generation</div>
              <div class="result-cell">Spatial Streams</div>
              <div class="result-cell">Antenna</div>
              <div class="result-cell">Form Factor</div>
              <div class="result-cell">MSRP</div>
              <div class="result-cell"></div>
            </div>
          </div>
          <div id="empty-state" class="empty-state" style="display:none;">
            <p>No APs match every selected requirement.</p>
            <p>Try removing one filter at a time to widen the results.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <button id="compare-fab" class="btn-primary floating-compare" style="display:none;" type="button">Compare (0)</button>

  <script>
    const DATA_URL = 'ap_data.json';
    const wifiOptions = [
      { id: 'wifi7', label: 'Wi-Fi 7 (2.4/5/6 GHz)' },
      { id: 'wifi6e', label: 'Wi-Fi 6E (2.4/5/6 GHz)' },
      { id: 'wifi6', label: 'Wi-Fi 6 (2.4/5 GHz)' }
    ];

    const state = {
      wifi: new Set(),
      vendors: new Set(),
      antenna: new Set(),
      form: new Set()
    };

    const selectedIds = new Set(); // For comparison
    let enrichedData = [];


    async function loadData() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const raw = await res.json();
        enrichedData = raw.map(enrichEntry);
        buildFilterOptions();
        applyFilters();
      } catch (err) {
        console.error('Failed to load data', err);
        document.getElementById('results-note').textContent = 'Unable to load AP data.';
      }
    }

    function enrichEntry(entry) {
      return Object.assign({}, entry, {
        _slug: slugFor(entry),
        _wifiFlags: deriveWifiFlags(entry.wifi_gen_radios),
        _antennaCategory: deriveAntennaCategory(entry.antenna_type)
      });
    }

    function deriveWifiFlags(value) {
      const flags = new Set();
      const text = String(value || '').toLowerCase();
      if (text.includes('wi-fi 7')) {
        flags.add('wifi7');
        flags.add('wifi6e');
        flags.add('wifi6');
      }
      if (text.includes('wi-fi 6e')) {
        flags.add('wifi6e');
        flags.add('wifi6');
      } else if (text.includes('wi-fi 6')) {
        flags.add('wifi6');
      }
      return flags;
    }

    function deriveAntennaCategory(value) {
      const text = String(value || '').toLowerCase();
      if (!text) return 'Other';
      if (text.includes('internal')) return 'Internal';
      if (text.includes('external')) return 'External';
      if (text.includes('directional')) return 'Directional';
      return 'Other';
    }

    function slugify(value) {
      return String(value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function slugFor(entry) {
      return slugify(`${entry.vendor || ''}-${entry.model || ''}`);
    }

    function escapeAttrValue(value) {
      if (window.CSS && typeof window.CSS.escape === 'function') {
        return window.CSS.escape(value);
      }
      return String(value).replace(/"/g, '\\"');
    }

    function buildFilterOptions() {
      renderCheckboxGroup('wifi-options', wifiOptions, 'wifi');

      const vendorOptions = collectUniqueValues('vendor').map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderCheckboxGroup('vendor-options', vendorOptions, 'vendors');

      const formValues = collectUniqueValues('form_factor').map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderCheckboxGroup('form-options', formValues, 'form');

      const antennaValues = Array.from(
        new Set(
          enrichedData
            .map(entry => entry._antennaCategory)
            .filter(label => label && label !== 'Other')
        )
      ).sort();
      const antennaOptions = antennaValues.map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderCheckboxGroup('antenna-options', antennaOptions, 'antenna');

      document.getElementById('results-note').textContent = 'Add filters to see matching APs.';
    }

    function collectUniqueValues(key) {
      const set = new Set();
      enrichedData.forEach(entry => {
        const value = (entry[key] || '').trim();
        if (value) set.add(value);
      });
      return Array.from(set).sort((a, b) => a.localeCompare(b));
    }

    function renderCheckboxGroup(targetId, options, type) {
      const container = document.getElementById(targetId);
      container.innerHTML = '';
      options.forEach(option => {
        const id = `${type}-${option.id || slugify(option.value || option.label)}`;
        const label = document.createElement('label');
        label.className = 'chip-option';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.dataset.filterType = type;
        input.dataset.filterValue = option.value || option.id;
        input.addEventListener('change', () => toggleSelection(type, input.dataset.filterValue, input.checked));
        const span = document.createElement('span');
        span.textContent = option.label;
        label.appendChild(input);
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    function toggleSelection(type, value, checked) {
      const targetSet = state[type];
      if (!targetSet) return;
      if (checked) targetSet.add(value);
      else targetSet.delete(value);
      applyFilters();
    }

    function applyFilters() {
      if (!enrichedData.length) return;
      const matches = enrichedData.filter(entry => matchesFilters(entry));
      renderActiveFilters();
      renderResults(matches);
      updateMatchCount(matches.length);
      document.getElementById('results-note').textContent = matches.length
        ? 'Showing APs that meet every selected requirement.'
        : 'No matches yet — broaden your filters.';
    }

    function matchesFilters(entry) {
      if (state.wifi.size) {
        for (const need of state.wifi) {
          if (!entry._wifiFlags.has(need)) return false;
        }
      }
      if (state.vendors.size && !state.vendors.has(entry.vendor)) return false;
      if (state.form.size && !state.form.has(entry.form_factor)) return false;
      if (state.antenna.size && !state.antenna.has(entry._antennaCategory)) return false;
      return true;
    }

    function renderResults(matches) {
      const container = document.getElementById('results');
      const emptyState = document.getElementById('empty-state');
      
      // Keep the header row, remove only data rows
      const header = container.querySelector('.result-header');
      container.innerHTML = '';
      if (header) container.appendChild(header);

      if (matches.length === 0) {
        emptyState.style.display = 'block';
        updateCompareFab();
        return;
      }
      emptyState.style.display = 'none';

      matches.forEach(entry => {
        const row = document.createElement('div');
        row.className = 'result-row';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'row-select';
        checkbox.checked = selectedIds.has(entry._slug);
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) selectedIds.add(entry._slug);
          else selectedIds.delete(entry._slug);
          updateCompareFab();
        });

        const vendor = document.createElement('div');
        vendor.className = 'result-cell result-vendor';
        vendor.textContent = entry.vendor || '';

        const model = document.createElement('div');
        model.className = 'result-cell result-model';
        const modelLink = document.createElement('a');
        modelLink.href = `ap.html?id=${encodeURIComponent(entry._slug)}`;
        modelLink.textContent = entry.model || '';
        model.appendChild(modelLink);

        const wifi = document.createElement('div');
        wifi.className = 'result-cell result-wifi';
        wifi.textContent = entry.wifi_gen_radios || '';

        const spatial = document.createElement('div');
        spatial.className = 'result-cell result-spatial';
        spatial.textContent = entry.spatial_streams || '—';

        const antenna = document.createElement('div');
        antenna.className = 'result-cell result-antenna';
        antenna.textContent = entry._antennaCategory || entry.antenna_type || '—';

        const form = document.createElement('div');
        form.className = 'result-cell result-form';
        form.textContent = entry.form_factor || '—';

        const msrp = document.createElement('div');
        msrp.className = 'result-cell result-msrp';
        msrp.textContent = entry.msrp || '—';

        const actions = document.createElement('div');
        actions.className = 'result-cell result-actions';
        const datasheetLink = document.createElement('a');
        if (entry.datasheet_url) {
          datasheetLink.href = entry.datasheet_url;
          datasheetLink.target = '_blank';
          datasheetLink.rel = 'noopener noreferrer';
          datasheetLink.className = 'btn-link btn-link-ghost btn-link-small';
          datasheetLink.textContent = 'Datasheet';
          actions.appendChild(datasheetLink);
        }

        row.appendChild(checkbox);
        row.appendChild(vendor);
        row.appendChild(model);
        row.appendChild(wifi);
        row.appendChild(spatial);
        row.appendChild(antenna);
        row.appendChild(form);
        row.appendChild(msrp);
        row.appendChild(actions);

        container.appendChild(row);
      });

      updateCompareFab();
    }

    function updateMatchCount(count) {
      const el = document.getElementById('match-count');
      el.textContent = count === 0 ? '0 matches' : `${count} match${count === 1 ? '' : 'es'}`;
    }

    function renderActiveFilters() {
      const container = document.getElementById('active-filters');
      container.innerHTML = '';
      const chips = [];

      function pushChips(type, values, formatter) {
        values.forEach(value => {
          chips.push({
            type,
            value,
            label: formatter ? formatter(value) : value
          });
        });
      }

      pushChips('wifi', state.wifi, value => {
        const option = wifiOptions.find(opt => opt.id === value);
        return option ? option.label : value;
      });
      pushChips('vendors', state.vendors);
      pushChips('antenna', state.antenna);
      pushChips('form', state.form);

      if (!chips.length) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      chips.forEach(chip => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'active-filter-chip';
        btn.textContent = chip.label;
        btn.addEventListener('click', () => removeFilter(chip.type, chip.value));
        container.appendChild(btn);
      });
    }

    function removeFilter(type, value) {
      const set = state[type];
      if (!set) return;
      set.delete(value);
      const selector = `input[data-filter-type="${type}"][data-filter-value="${escapeAttrValue(value)}"]`;
      const input = document.querySelector(selector);
      if (input) input.checked = false;
      applyFilters();
    }

    function clearAllFilters() {
      Object.keys(state).forEach(key => state[key].clear());
      document.querySelectorAll('input[data-filter-type]').forEach(input => {
        input.checked = false;
      });
      selectedIds.clear();
      applyFilters();
    }

    function updateCompareFab() {
      const fab = document.getElementById('compare-fab');
      const n = selectedIds.size;
      if (n >= 2) {
        fab.style.display = 'inline-flex';
        fab.textContent = `Compare (${n})`;
      } else {
        fab.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      const compareFab = document.getElementById('compare-fab');
      if (compareFab) {
        compareFab.addEventListener('click', () => {
          if (selectedIds.size < 2) return;
          const idsParam = Array.from(selectedIds).join(',');
          window.location.href = `compare.html?ids=${encodeURIComponent(idsParam)}`;
        });
      }
      loadData();
    });
  </script>
</body>
</html>

