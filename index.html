<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wi-Fi AP Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
  <div class="actions">
    <a class="btn-link" href="submit.html">Submit New AP</a>
    <a class="btn-link" href="edit.html">Edit Existing AP Information</a>
    <input id="search" class="search-input" type="search" placeholder="Search vendor, model, features, PoEâ€¦" />
    <select id="filter-vendor" class="filter-select" title="Filter by vendor">
      <option value="">All Vendors</option>
    </select>
    <select id="filter-antenna" class="filter-select" title="Filter by antenna type">
      <option value="">All Antenna Types</option>
      <option>Internal</option>
      <option>External</option>
      <option>Directional</option>
    </select>
    <select id="filter-form" class="filter-select" title="Filter by form factor">
      <option value="">All Form Factors</option>
      <option>Indoor</option>
      <option>Outdoor</option>
      <option>Wallplate</option>
    </select>
  </div>

    <div class="card">
      <span class="badge">Community-maintained</span>

      <table>
        <thead>
          <tr>
            <th class="sortable" data-key="vendor">Vendor</th>
            <th class="sortable" data-key="model">Model</th>
            <th class="sortable" data-key="wifi_gen_radios">Wi-Fi Gen &amp; Radios</th>
            <th class="sortable" data-key="spatial_streams">Spatial Streams<br>(2.4 / 5 / 6 GHz)</th>
            <th class="sortable" data-key="min_poe_class">Min PoE Class</th>
            <th class="sortable" data-key="recommended_poe">Recommended PoE</th>
            <th class="sortable" data-key="behavior_min_power">Behavior at Min Power</th>
            <th class="sortable" data-key="ethernet_ports_speed">Ethernet Ports &amp; Speed</th>
            <th class="sortable" data-key="radios_iot_features">Radios &amp; IoT Features</th>
            <th class="sortable" data-key="antenna_type">Antenna Type</th>
            <th class="sortable" data-key="form_factor">Form Factor</th>
            <th class="sortable" data-key="msrp">MSRP</th>
          </tr>
        </thead>
        <tbody id="ap-table-body">
          <!-- Rows will be populated dynamically from ap_data.json -->
        </tbody>
      </table>

      <div id="error-message" class="error" style="display:none;"></div>

      <div class="footer">
        Maintained by Dan Ryan. To add a new AP or request an edit, use the buttons above.
      </div>
    </div>
  </div>

  <script>
    // Path to the data file in your repo root
    const DATA_URL = 'ap_data.json';

    let apData = [];
    let currentQuery = '';
    const currentFilters = { vendor: '', antenna: '', form: '' };
    let currentSort = { key: 'vendor', dir: 'asc' };

    function normalizeString(value) {
      if (value == null) return '';
      if (Array.isArray(value)) return value.join(', ');
      return String(value);
    }

    function populateFilters() {
      const vendorSelect = document.getElementById('filter-vendor');
      const vendors = Array.from(new Set(apData.map(e => e.vendor).filter(Boolean))).sort((a, b) =>
        a.localeCompare(b)
      );
      // Clear all except first option
      while (vendorSelect.options.length > 1) vendorSelect.remove(1);
      vendors.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vendorSelect.appendChild(opt);
      });
    }

    function updateSortIndicators() {
      const ths = document.querySelectorAll('th.sortable');
      ths.forEach(th => {
        if (th.dataset.key === currentSort.key) {
          th.setAttribute('data-dir', currentSort.dir);
        } else {
          th.removeAttribute('data-dir');
        }
      });
    }

    function renderTable() {
      const tbody = document.getElementById('ap-table-body');
      const errorEl = document.getElementById('error-message');

      // filter data
      const q = currentQuery.trim().toLowerCase();
      const filtered = apData.filter(entry => {
        if (currentFilters.vendor && entry.vendor !== currentFilters.vendor) return false;
        if (currentFilters.antenna && (entry.antenna_type || '').toLowerCase() !== currentFilters.antenna.toLowerCase()) return false;
        if (currentFilters.form && (entry.form_factor || '').toLowerCase() !== currentFilters.form.toLowerCase()) return false;
        if (!q) return true;
        const haystack =
          [
            'vendor',
            'model',
            'wifi_gen_radios',
            'spatial_streams',
            'min_poe_class',
            'recommended_poe',
            'behavior_min_power',
            'ethernet_ports_speed',
            'form_factor',
            'msrp'
          ]
            .map(k => normalizeString(entry[k]))
            .join(' ')
            .toLowerCase() +
          ' ' +
          normalizeString(entry.radios_iot_features).toLowerCase() +
          ' ' +
          normalizeString(entry.antenna_type).toLowerCase();
        return haystack.includes(q);
      });

      // sort
      const key = currentSort.key;
      const dir = currentSort.dir === 'asc' ? 1 : -1;
      const sorted = filtered.slice().sort((a, b) => {
        const av = normalizeString(Array.isArray(a[key]) ? a[key].join(', ') : a[key]).toLowerCase();
        const bv = normalizeString(Array.isArray(b[key]) ? b[key].join(', ') : b[key]).toLowerCase();
        return av.localeCompare(bv) * dir;
      });

      // Clear and render
      tbody.innerHTML = '';

      sorted.forEach(entry => {
        const tr = document.createElement('tr');

        function textCell(text, className) {
          const td = document.createElement('td');
          if (className) td.classList.add(className);
          td.textContent = text || '';
          return td;
        }

        tr.appendChild(textCell(entry.vendor, 'vendor'));
        tr.appendChild(textCell(entry.model));
        tr.appendChild(textCell(entry.wifi_gen_radios));
        tr.appendChild(textCell(entry.spatial_streams));
        tr.appendChild(textCell(entry.min_poe_class));
        tr.appendChild(textCell(entry.recommended_poe));

        const behaviorTd = document.createElement('td');
        behaviorTd.classList.add('behavior');
        const behaviorText = entry.behavior_min_power || '';
        behaviorTd.textContent = behaviorText;
        behaviorTd.setAttribute('data-fulltext', behaviorText);
        tr.appendChild(behaviorTd);

        tr.appendChild(textCell(entry.ethernet_ports_speed));

        const radiosTd = document.createElement('td');
        if (Array.isArray(entry.radios_iot_features)) {
          entry.radios_iot_features.forEach(feature => {
            const span = document.createElement('span');
            span.classList.add('tag');
            span.textContent = feature;
            radiosTd.appendChild(span);
          });
        } else if (typeof entry.radios_iot_features === 'string') {
          radiosTd.textContent = entry.radios_iot_features;
        }
        tr.appendChild(radiosTd);

        tr.appendChild(textCell(entry.antenna_type));
        tr.appendChild(textCell(entry.form_factor));
        tr.appendChild(textCell(entry.msrp));

        tbody.appendChild(tr);
      });

      if (sorted.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.setAttribute('colspan', '12');
        td.textContent = currentQuery || currentFilters.vendor || currentFilters.antenna || currentFilters.form
          ? 'No APs match your search or filters.'
          : 'No APs defined yet. Add entries to ap_data.json.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      updateSortIndicators();
    }

    function readStateFromUrl() {
      const params = new URLSearchParams(window.location.search);
      currentQuery = params.get('q') || '';
      currentFilters.vendor = params.get('v') || '';
      currentFilters.antenna = params.get('a') || '';
      currentFilters.form = params.get('f') || '';
      const s = params.get('s');
      const d = params.get('d');
      if (s) currentSort.key = s;
      if (d === 'asc' || d === 'desc') currentSort.dir = d;
    }

    function updateUrl() {
      const params = new URLSearchParams();
      if (currentQuery) params.set('q', currentQuery);
      if (currentFilters.vendor) params.set('v', currentFilters.vendor);
      if (currentFilters.antenna) params.set('a', currentFilters.antenna);
      if (currentFilters.form) params.set('f', currentFilters.form);
      if (currentSort.key !== 'vendor') params.set('s', currentSort.key);
      if (currentSort.dir !== 'asc') params.set('d', currentSort.dir);
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      history.replaceState({}, '', newUrl);
    }
    async function loadApData() {
      const errorEl = document.getElementById('error-message');

      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }
        const data = await res.json();
        if (!Array.isArray(data)) {
          throw new Error('Data format error: expected an array');
        }
        apData = data;
        populateFilters();
        // Reflect URL state into controls after options are available
        const searchEl = document.getElementById('search');
        const vendorEl = document.getElementById('filter-vendor');
        const antennaEl = document.getElementById('filter-antenna');
        const formEl = document.getElementById('filter-form');
        if (searchEl) searchEl.value = currentQuery;
        if (vendorEl) vendorEl.value = currentFilters.vendor || '';
        if (antennaEl) antennaEl.value = currentFilters.antenna || '';
        if (formEl) formEl.value = currentFilters.form || '';
        renderTable();
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      } catch (err) {
        console.error('Failed to load AP data:', err);
        errorEl.style.display = 'block';
        errorEl.textContent = 'Failed to load AP data. Please try again later or check ap_data.json.';
      }
    }

    // Wire up search + filters + sorting + URL state
    document.addEventListener('DOMContentLoaded', () => {
      readStateFromUrl();

      const searchEl = document.getElementById('search');
      if (searchEl) {
        searchEl.addEventListener('input', () => {
          currentQuery = searchEl.value;
          renderTable();
          updateUrl();
        });
        // reflect initial state
        searchEl.value = currentQuery;
      }
      const vendorEl = document.getElementById('filter-vendor');
      const antennaEl = document.getElementById('filter-antenna');
      const formEl = document.getElementById('filter-form');
      vendorEl.addEventListener('change', () => {
        currentFilters.vendor = vendorEl.value;
        renderTable();
        updateUrl();
      });
      antennaEl.addEventListener('change', () => {
        currentFilters.antenna = antennaEl.value;
        renderTable();
        updateUrl();
      });
      formEl.addEventListener('change', () => {
        currentFilters.form = formEl.value;
        renderTable();
        updateUrl();
      });

      // Header sort click handlers
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (!key) return;
          if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.key = key;
            currentSort.dir = 'asc';
          }
          updateSortIndicators();
          renderTable();
          updateUrl();
        });
      });
    });

    loadApData();
  </script>
</body>
</html>
