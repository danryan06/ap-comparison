<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Compare APs — Enterprise AP Comparison Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="actions">
      <a id="back-link" class="btn-link" href="index.html">&larr; Back to AP Table</a>
      <button id="toggle-columns" type="button" class="btn-link">Choose Columns</button>
      <button id="export-csv" type="button" class="btn-link">Export CSV</button>
    </div>

    <div class="card">
      <span class="badge">Comparison</span>
      <h1><a href="index.html">Enterprise AP Comparison Database</a></h1>
      <h2>Compare Access Points</h2>
      <p class="subtitle">Side-by-side details for selected APs.</p>

      <div id="error-message" class="error" style="display:none;"></div>

      <div id="columns-panel" class="columns-panel" style="display:none;">
        <h3>Show/Hide Columns</h3>
        <div id="columns-grid" class="columns-grid"></div>
      </div>

      <table id="compare-table">
        <thead>
          <tr id="compare-header"></tr>
        </thead>
        <tbody id="compare-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const DATA_URL = 'ap_data.json';
    const HIDDEN_KEY = 'compareTable.cols';
    const hiddenColumns = new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY) || '[]'));
    const ORDER_KEY = 'compareTable.colOrder';
    const WIDTHS_KEY = 'compareTable.colWidths';
    let currentSelected = [];
    let currentVisibleColumns = [];

    function slugify(s) {
      return String(s || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function readIds() {
      const params = new URLSearchParams(window.location.search);
      const ids = (params.get('ids') || '').split(',').map(s => s.trim()).filter(Boolean);
      return ids;
    }

    function normalizeString(value) {
      if (value == null) return '';
      if (Array.isArray(value)) return value.join(', ');
      return String(value);
    }

    function buildBackLink() {
      const params = new URLSearchParams(window.location.search);
      params.delete('ids');
      const backEl = document.getElementById('back-link');
      const backUrl = 'index.html' + (params.toString() ? '?' + params.toString() : '');
      backEl.setAttribute('href', backUrl);
    }

    function buildColumnsPanel(columns) {
      const grid = document.getElementById('columns-grid');
      grid.innerHTML = '';
      const makeRow = (label, key, lock=false) => {
        const lbl = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !hiddenColumns.has(key) || lock;
        input.disabled = lock;
        input.addEventListener('change', () => {
          if (input.checked) hiddenColumns.delete(key);
          else hiddenColumns.add(key);
          localStorage.setItem(HIDDEN_KEY, JSON.stringify(Array.from(hiddenColumns)));
          load(); // rebuild table with new column set
        });
        const span = document.createElement('span');
        span.textContent = label;
        lbl.appendChild(input);
        lbl.appendChild(span);
        grid.appendChild(lbl);
      };
      // Locked vendor/model
      makeRow('Vendor', '__vendor__', true);
      makeRow('Model', '__model__', true);
      columns.forEach(([label, key]) => makeRow(label, key, false));
    }

    async function load() {
      buildBackLink();
      const errorEl = document.getElementById('error-message');
      const headerRow = document.getElementById('compare-header');
      const bodyEl = document.getElementById('compare-body');

      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const ids = readIds();
        const selected = data.filter(e => ids.includes(slugify(`${e.vendor} ${e.model}`)));
        if (selected.length < 2) {
          errorEl.style.display = 'block';
          errorEl.textContent = 'Select at least two APs to compare.';
          return;
        }

        // Build header/rows with columns chooser (attributes as columns)
        const columns = [
          ['Wi‑Fi Gen & Radios', 'wifi_gen_radios'],
          ['Spatial Streams', 'spatial_streams'],
          ['Min PoE Class', 'min_poe_class'],
          ['Recommended PoE', 'recommended_poe'],
          ['Behavior at Min Power', 'behavior_min_power'],
          ['Ethernet Ports & Speed', 'ethernet_ports_speed'],
          ['Antenna Type', 'antenna_type'],
          ['Form Factor', 'form_factor'],
          ['Dimensions', 'dimensions'],
          ['Weight', 'weight'],
          ['Antenna Connectors', 'antenna_connectors'],
          ['Operating Temp Range', 'operating_temp_range'],
          ['Radios & IoT Features', 'radios_iot_features'],
          ['MSRP', 'msrp'],
          ['Datasheet', 'datasheet_url']
        ];

        headerRow.innerHTML = '';
        const vendorTh = document.createElement('th');
        vendorTh.textContent = 'Vendor';
        vendorTh.dataset.key = '__vendor__';
        headerRow.appendChild(vendorTh);
        const modelTh = document.createElement('th');
        modelTh.textContent = 'Model';
        modelTh.dataset.key = 'model';
        headerRow.appendChild(modelTh);
        const visibleCols = columns.filter(([, key]) => !hiddenColumns.has(key));
        visibleCols.forEach(([label]) => {
          const th = document.createElement('th');
          th.textContent = label;
          // Find key for dataset
          const pair = visibleCols.find(([lbl]) => lbl === label);
          const key = pair ? pair[1] : '';
          th.dataset.key = key;
          headerRow.appendChild(th);
        });

        bodyEl.innerHTML = '';
        selected.forEach(e => {
          const tr = document.createElement('tr');
          const vendorTd = document.createElement('td');
          vendorTd.textContent = e.vendor || '';
          tr.appendChild(vendorTd);
          const modelTd = document.createElement('td');
          modelTd.textContent = e.model || '';
          tr.appendChild(modelTd);
          visibleCols.forEach(([label, key]) => {
            const td = document.createElement('td');
            if (key === 'datasheet_url' && e[key]) {
              const a = document.createElement('a');
              a.href = e[key];
              a.target = '_blank';
              a.rel = 'noopener';
              a.textContent = 'Open';
              td.appendChild(a);
            } else if (Array.isArray(e[key])) {
              td.textContent = e[key].join(', ');
            } else {
              td.textContent = normalizeString(e[key]);
            }
            tr.appendChild(td);
          });
          bodyEl.appendChild(tr);
        });

        // Build columns panel after we know columns
        buildColumnsPanel(columns);
        // Save context for CSV/export
        currentSelected = selected;
        currentVisibleColumns = visibleCols;

        // Initialize resizers and DnD, then apply saved layout
        initCompareColumnResizersAndDnD();
        compareLoadLayout();
      } catch (err) {
        console.error('Failed to load comparison:', err);
        errorEl.style.display = 'block';
        errorEl.textContent = 'Failed to load comparison.';
      }
    }

    // Toggle for columns panel
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('toggle-columns');
      const panel = document.getElementById('columns-panel');
      btn.addEventListener('click', () => {
        const isOpen = panel.style.display === 'block';
        panel.style.display = isOpen ? 'none' : 'block';
      });
      // Export CSV
      const exportBtn = document.getElementById('export-csv');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          if (!currentSelected.length) return;
          const headers = ['Vendor', 'Model', ...currentVisibleColumns.map(([label]) => label)];
          const keys = ['__vendor__', 'model', ...currentVisibleColumns.map(([, key]) => key)];
          const rows = currentSelected.map(e => {
            return keys.map(k => {
              if (k === '__vendor__') return normalizeString(e.vendor);
              const v = e[k];
              const s = Array.isArray(v) ? v.join('; ') : normalizeString(v);
              // Escape CSV
              const needs = /[\",\\n]/.test(s);
              return needs ? '\"' + s.replace(/\"/g, '\"\"') + '\"' : s;
            }).join(',');
          });
          const csv = headers.join(',') + '\\n' + rows.join('\\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ap-comparison.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }
    });

    load();

    // ----- Column resize and drag/drop for compare table -----
    let isResizing = false;
    function compareSaveLayout() {
      const ths = Array.from(document.querySelectorAll('#compare-table thead th'));
      const order = ths.map(th => th.dataset.key || '');
      const widths = {};
      ths.forEach(th => {
        const key = th.dataset.key || '';
        const w = th.style.width || '';
        if (key) widths[key] = w;
      });
      localStorage.setItem(ORDER_KEY, JSON.stringify(order));
      localStorage.setItem(WIDTHS_KEY, JSON.stringify(widths));
    }

    function compareLoadLayout() {
      const headerRow = document.querySelector('#compare-table thead tr');
      if (!headerRow) return;
      const storedOrder = JSON.parse(localStorage.getItem(ORDER_KEY) || '[]');
      const storedWidths = JSON.parse(localStorage.getItem(WIDTHS_KEY) || '{}');
      if (Array.isArray(storedOrder) && storedOrder.length > 0) {
        const map = {};
        Array.from(headerRow.children).forEach(th => { map[th.dataset.key || ''] = th; });
        storedOrder.forEach(key => {
          const th = map[key];
          if (th) headerRow.appendChild(th);
        });
      }
      // apply widths
      const ths = Array.from(headerRow.children);
      ths.forEach((th, index) => {
        const key = th.dataset.key || '';
        const w = storedWidths[key];
        if (w) {
          th.style.width = w;
          const tbody = document.querySelector('#compare-table tbody');
          if (tbody) {
            Array.from(tbody.rows).forEach(row => {
              const cell = row.children[index];
              if (cell) cell.style.width = w;
            });
          }
        }
      });
      applyCompareColumnOrderFromHeader();
    }

    function applyCompareColumnOrderFromHeader() {
      const headerRow = document.querySelector('#compare-table thead tr');
      if (!headerRow) return;
      const ths = Array.from(headerRow.children);
      const tbody = document.querySelector('#compare-table tbody');
      if (!tbody) return;
      Array.from(tbody.rows).forEach(row => {
        const cells = Array.from(row.children);
        const reordered = ths.map((_, idx) => cells[idx]);
        reordered.forEach(cell => row.appendChild(cell));
      });
    }

    function initCompareColumnResizersAndDnD() {
      const headerRow = document.querySelector('#compare-table thead tr');
      if (!headerRow) return;
      const ths = Array.from(headerRow.querySelectorAll('th'));
      ths.forEach((th, index) => {
        // prevent dragging vendor/model columns
        const key = th.dataset.key || '';
        const isLocked = key === '__vendor__' || key === 'model';
        // Add resizer
        if (!th.querySelector('.col-resizer')) {
          const resizer = document.createElement('span');
          resizer.className = 'col-resizer';
          th.appendChild(resizer);
          let startX, startWidth;
          let blockDragStart;
          const onMouseMove = (e) => {
            const delta = e.clientX - startX;
            const newWidth = Math.max(60, startWidth + delta);
            th.style.width = newWidth + 'px';
            const tbody = document.querySelector('#compare-table tbody');
            if (tbody) {
              Array.from(tbody.rows).forEach(row => {
                const cell = row.children[index];
                if (cell) cell.style.width = newWidth + 'px';
              });
            }
          };
          const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.removeEventListener('dragstart', blockDragStart, true);
            isResizing = false;
            if (!isLocked) th.draggable = true;
            compareSaveLayout();
          };
          resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            e.preventDefault();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            isResizing = true;
            th.draggable = false;
            blockDragStart = (ev) => { ev.preventDefault(); };
            document.addEventListener('dragstart', blockDragStart, true);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });
        }
        // Drag/drop reorder (skip locked)
        if (!isLocked) {
          th.setAttribute('draggable', 'true');
          th.addEventListener('dragstart', (e) => {
            if (isResizing) { e.preventDefault(); return; }
            const currentIndex = Array.from(th.parentNode.children).indexOf(th);
            e.dataTransfer.setData('text/plain', String(currentIndex));
          });
          th.addEventListener('dragover', (e) => {
            e.preventDefault();
            const rect = th.getBoundingClientRect();
            const halfway = rect.left + rect.width / 2;
            th.classList.toggle('drag-over-left', e.clientX < halfway);
            th.classList.toggle('drag-over-right', e.clientX >= halfway);
          });
          th.addEventListener('dragleave', () => {
            th.classList.remove('drag-over-left', 'drag-over-right');
          });
          th.addEventListener('drop', (e) => {
            e.preventDefault();
            const srcIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
            const srcTh = ths[srcIndex];
            const rect = th.getBoundingClientRect();
            const after = e.clientX >= rect.left + rect.width / 2;
            th.classList.remove('drag-over-left', 'drag-over-right');
            if (srcTh && srcTh !== th) {
              if (after) {
                th.parentNode.insertBefore(srcTh, th.nextSibling);
              } else {
                th.parentNode.insertBefore(srcTh, th);
              }
              applyCompareColumnOrderFromHeader();
              compareSaveLayout();
            }
          });
        }
      });
    }
  </script>
</body>
</html>

