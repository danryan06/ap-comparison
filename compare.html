<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Compare APs — Wi‑Fi AP Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="actions">
      <a id="back-link" class="btn-link" href="index.html">&larr; Back to AP Table</a>
      <button id="toggle-columns" type="button" class="btn-link">Choose Columns</button>
    </div>

    <div class="card">
      <span class="badge">Comparison</span>
      <h1>Compare Access Points</h1>
      <p class="subtitle">Side-by-side details for selected APs.</p>

      <div id="error-message" class="error" style="display:none;"></div>

      <div id="columns-panel" class="columns-panel" style="display:none;">
        <h3>Show/Hide Columns</h3>
        <div id="columns-grid" class="columns-grid"></div>
      </div>

      <table id="compare-table">
        <thead>
          <tr id="compare-header"></tr>
        </thead>
        <tbody id="compare-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const DATA_URL = 'ap_data.json';
    const HIDDEN_KEY = 'compareTable.cols';
    const hiddenColumns = new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY) || '[]'));

    function slugify(s) {
      return String(s || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function readIds() {
      const params = new URLSearchParams(window.location.search);
      const ids = (params.get('ids') || '').split(',').map(s => s.trim()).filter(Boolean);
      return ids;
    }

    function normalizeString(value) {
      if (value == null) return '';
      if (Array.isArray(value)) return value.join(', ');
      return String(value);
    }

    function buildBackLink() {
      const params = new URLSearchParams(window.location.search);
      params.delete('ids');
      const backEl = document.getElementById('back-link');
      const backUrl = 'index.html' + (params.toString() ? '?' + params.toString() : '');
      backEl.setAttribute('href', backUrl);
    }

    function buildColumnsPanel(columns) {
      const grid = document.getElementById('columns-grid');
      grid.innerHTML = '';
      const makeRow = (label, key, lock=false) => {
        const lbl = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !hiddenColumns.has(key) || lock;
        input.disabled = lock;
        input.addEventListener('change', () => {
          if (input.checked) hiddenColumns.delete(key);
          else hiddenColumns.add(key);
          localStorage.setItem(HIDDEN_KEY, JSON.stringify(Array.from(hiddenColumns)));
          load(); // rebuild table with new column set
        });
        const span = document.createElement('span');
        span.textContent = label;
        lbl.appendChild(input);
        lbl.appendChild(span);
        grid.appendChild(lbl);
      };
      // Locked vendor/model
      makeRow('Vendor', '__vendor__', true);
      makeRow('Model', '__model__', true);
      columns.forEach(([label, key]) => makeRow(label, key, false));
    }

    async function load() {
      buildBackLink();
      const errorEl = document.getElementById('error-message');
      const headerRow = document.getElementById('compare-header');
      const bodyEl = document.getElementById('compare-body');

      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const ids = readIds();
        const selected = data.filter(e => ids.includes(slugify(`${e.vendor} ${e.model}`)));
        if (selected.length < 2) {
          errorEl.style.display = 'block';
          errorEl.textContent = 'Select at least two APs to compare.';
          return;
        }

        // Build header/rows with columns chooser (attributes as columns)
        const columns = [
          ['Wi‑Fi Gen & Radios', 'wifi_gen_radios'],
          ['Spatial Streams', 'spatial_streams'],
          ['Min PoE Class', 'min_poe_class'],
          ['Recommended PoE', 'recommended_poe'],
          ['Behavior at Min Power', 'behavior_min_power'],
          ['Ethernet Ports & Speed', 'ethernet_ports_speed'],
          ['Antenna Type', 'antenna_type'],
          ['Form Factor', 'form_factor'],
          ['Dimensions', 'dimensions'],
          ['Weight', 'weight'],
          ['Antenna Connectors', 'antenna_connectors'],
          ['Operating Temp Range', 'operating_temp_range'],
          ['Radios & IoT Features', 'radios_iot_features'],
          ['MSRP', 'msrp'],
          ['Datasheet', 'datasheet_url']
        ];

        headerRow.innerHTML = '';
        const vendorTh = document.createElement('th');
        vendorTh.textContent = 'Vendor';
        headerRow.appendChild(vendorTh);
        const modelTh = document.createElement('th');
        modelTh.textContent = 'Model';
        headerRow.appendChild(modelTh);
        const visibleCols = columns.filter(([, key]) => !hiddenColumns.has(key));
        visibleCols.forEach(([label]) => {
          const th = document.createElement('th');
          th.textContent = label;
          headerRow.appendChild(th);
        });

        bodyEl.innerHTML = '';
        selected.forEach(e => {
          const tr = document.createElement('tr');
          const vendorTd = document.createElement('td');
          vendorTd.textContent = e.vendor || '';
          tr.appendChild(vendorTd);
          const modelTd = document.createElement('td');
          modelTd.textContent = e.model || '';
          tr.appendChild(modelTd);
          visibleCols.forEach(([label, key]) => {
            const td = document.createElement('td');
            if (key === 'datasheet_url' && e[key]) {
              const a = document.createElement('a');
              a.href = e[key];
              a.target = '_blank';
              a.rel = 'noopener';
              a.textContent = 'Open';
              td.appendChild(a);
            } else if (Array.isArray(e[key])) {
              td.textContent = e[key].join(', ');
            } else {
              td.textContent = normalizeString(e[key]);
            }
            tr.appendChild(td);
          });
          bodyEl.appendChild(tr);
        });

        // Build columns panel after we know columns
        buildColumnsPanel(columns);
      } catch (err) {
        console.error('Failed to load comparison:', err);
        errorEl.style.display = 'block';
        errorEl.textContent = 'Failed to load comparison.';
      }
    }

    // Toggle for columns panel
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('toggle-columns');
      const panel = document.getElementById('columns-panel');
      btn.addEventListener('click', () => {
        const isOpen = panel.style.display === 'block';
        panel.style.display = isOpen ? 'none' : 'block';
      });
    });

    load();
  </script>
</body>
</html>

