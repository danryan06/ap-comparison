<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit New AP &mdash; Wi-Fi AP Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Submit New AP</h1>
    <p class="subtitle">
      Use this form to generate a standardized JSON entry for a new access point. Then click
      “Open GitHub New AP Form”, paste the JSON into the <strong>JSON Snippet</strong> field, and submit.
    </p>

    <div class="actions">
      <a class="btn-link" href="index.html">&larr; Back to AP Table</a>
    </div>

    <div class="card">
      <span class="badge">New AP</span>

      <form id="new-ap-form">
        <div class="form-grid">
          <div class="form-row">
            <label for="vendor">Vendor</label>
            <input id="vendor" name="vendor" type="text" placeholder="Juniper, Cisco, Aruba, Ruckus, etc." required />
          </div>

          <div class="form-row">
            <label for="model">Model</label>
            <input id="model" name="model" type="text" placeholder="AP45, Catalyst 9166I, AP-655, etc." required />
          </div>
          <div class="form-row" id="dup-row" style="display:none;">
            <div id="dup-warning" class="error">Possible duplicate detected.</div>
          </div>

          <div class="form-row">
            <label for="wifi_gen_radios">Wi-Fi Gen &amp; Radios</label>
            <input id="wifi_gen_radios" name="wifi_gen_radios" type="text" placeholder="Wi-Fi 6E (2.4/5/6)" required />
          </div>

          <div class="form-row">
            <label for="spatial_streams">Spatial Streams (2.4 / 5 / 6 GHz)</label>
            <input id="spatial_streams" name="spatial_streams" type="text" placeholder="4x4 / 4x4 / 4x4" required />
          </div>

          <div class="form-row">
            <label for="min_poe_class">Min PoE Class</label>
            <input id="min_poe_class" name="min_poe_class" type="text" placeholder="802.3at (Class 4)" required />
          </div>

          <div class="form-row">
            <label for="recommended_poe">Recommended PoE</label>
            <input id="recommended_poe" name="recommended_poe" type="text" placeholder="802.3bt (Class 6) or 30 W, etc." required />
          </div>

          <div class="form-row">
            <label for="behavior_min_power">Behavior at Min Power</label>
            <textarea id="behavior_min_power" name="behavior_min_power" placeholder="1–2 sentences about what the AP does at minimum PoE (e.g., disables USB, reduces TX power, shuts off a band)." required></textarea>
          </div>

          <div class="form-row">
            <label for="ethernet_ports_speed">Ethernet Ports &amp; Speed</label>
            <input id="ethernet_ports_speed" name="ethernet_ports_speed" type="text" placeholder="1×2.5GbE, 2×5GbE, etc." required />
          </div>

          <div class="form-row">
            <label for="antenna_type">Antenna Type</label>
            <select id="antenna_type" name="antenna_type" required>
              <option value="" disabled selected>Select antenna type</option>
              <option>Internal</option>
              <option>External</option>
              <option>Directional</option>
            </select>
          </div>

          <div class="form-row">
            <label for="form_factor">Form Factor</label>
            <select id="form_factor" name="form_factor" required>
              <option value="" disabled selected>Select form factor</option>
              <option>Indoor</option>
              <option>Outdoor</option>
              <option>Wallplate</option>
            </select>
          </div>

          <div class="form-row">
            <label for="radios_iot_features">Radios &amp; IoT Features (comma-separated)</label>
            <input id="radios_iot_features" name="radios_iot_features" type="text" placeholder="BLE, Zigbee, GPS, vBLE array, sensor radio" />
          </div>

          <div class="form-row">
            <label for="dimensions">Dimensions</label>
            <input id="dimensions" name="dimensions" type="text" placeholder='e.g., 240 × 240 × 61 mm' />
          </div>

          <div class="form-row">
            <label for="weight">Weight</label>
            <input id="weight" name="weight" type="text" placeholder="e.g., 1.2 kg or 2.6 lb" />
          </div>

          <div class="form-row">
            <label for="antenna_connectors">Antenna Connectors</label>
            <input id="antenna_connectors" name="antenna_connectors" type="text" placeholder="Free-form (e.g., 4×RP-SMA, none)" />
          </div>

          <div class="form-row">
            <label for="operating_temp_range">Operating Temperature Range</label>
            <input id="operating_temp_range" name="operating_temp_range" type="text" placeholder="e.g., -20°C to 50°C" />
          </div>

          <div class="form-row">
            <label for="msrp">MSRP</label>
            <input id="msrp" name="msrp" type="text" placeholder="~$2,195" required />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Generate JSON Snippet</button>
          <button type="button" class="btn-link" id="open-issue-btn">Open GitHub Issue with This Entry</button>
        </div>
      </form>

      <div class="output-box">
        <label for="output">Generated JSON entry (add this object to <code>ap_data.json</code>):</label>
        <textarea id="output" readonly placeholder="Your JSON snippet will appear here after you generate it."></textarea>
      </div>

      <div class="footer">
        Workflow: Generate JSON ➜ open the GitHub New AP form ➜ paste the snippet into the <code>JSON Snippet</code> field ➜ submit.
        A GitHub Action will turn your submission into a pull request.
      </div>

    </div>
  </div>

  <script>
    // TODO: set these to your actual GitHub username and repo name
    const GITHUB_USER = 'danryan06';
    const GITHUB_REPO = 'ap-comparison';
    const DATA_URL = 'ap_data.json';

    let existingSlugSet = new Set();
    function normalizeForSlug(s) {
      if (!s) return '';
      return String(s)
        .toLowerCase()
        .trim()
        .replace(/[\\u2010-\\u2015\\u2212]/g, '-')      // normalize dashes
        .replace(/\\s+/g, ' ');                        // collapse spaces
    }
    function makeSlug(vendor, model) {
      return normalizeForSlug(vendor) + '|' + normalizeForSlug(model);
    }
    async function loadExistingSlugsOnce() {
      if (existingSlugSet.size > 0) return;
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        data.forEach(e => existingSlugSet.add(makeSlug(e.vendor, e.model)));
      } catch {}
    }
    function showDupWarning(show, matchLabel) {
      const row = document.getElementById('dup-row');
      const box = document.getElementById('dup-warning');
      if (show) {
        box.textContent = `Heads up: "${matchLabel}" already exists. Consider using Edit Existing AP.`;
        row.style.display = 'block';
      } else {
        row.style.display = 'none';
      }
    }
    async function checkDuplicate() {
      await loadExistingSlugsOnce();
      const vendor = document.getElementById('vendor').value;
      const model = document.getElementById('model').value;
      const slug = makeSlug(vendor, model);
      const isDup = existingSlugSet.has(slug);
      showDupWarning(isDup, `${vendor} ${model}`.trim());
      return isDup;
    }
    ['vendor','model'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => { checkDuplicate(); });
      el.addEventListener('blur', () => { checkDuplicate(); });
    });
    // Preload slugs
    loadExistingSlugsOnce();

    function buildApObjectFromForm() {
      const vendor = document.getElementById('vendor').value.trim();
      const model = document.getElementById('model').value.trim();
      const wifi_gen_radios = document.getElementById('wifi_gen_radios').value.trim();
      const spatial_streams = document.getElementById('spatial_streams').value.trim();
      const min_poe_class = document.getElementById('min_poe_class').value.trim();
      const recommended_poe = document.getElementById('recommended_poe').value.trim();
      const behavior_min_power = document.getElementById('behavior_min_power').value.trim();
      const ethernet_ports_speed = document.getElementById('ethernet_ports_speed').value.trim();
      const antenna_type = document.getElementById('antenna_type').value.trim();
      const form_factor = document.getElementById('form_factor').value.trim();
      const radios_iot_features_raw = document.getElementById('radios_iot_features').value.trim();
      const dimensions = document.getElementById('dimensions').value.trim();
      const weight = document.getElementById('weight').value.trim();
      const antenna_connectors = document.getElementById('antenna_connectors').value.trim();
      const operating_temp_range = document.getElementById('operating_temp_range').value.trim();
      const msrp = document.getElementById('msrp').value.trim();

      let radios_iot_features = [];
      if (radios_iot_features_raw.length > 0) {
        radios_iot_features = radios_iot_features_raw
          .split(',')
          .map(s => s.trim())
          .filter(s => s.length > 0);
      }

      return {
        vendor,
        model,
        wifi_gen_radios,
        spatial_streams,
        min_poe_class,
        recommended_poe,
        behavior_min_power,
        ethernet_ports_speed,
        antenna_type,
        form_factor,
        radios_iot_features,
        dimensions,
        weight,
        antenna_connectors,
        operating_temp_range,
        msrp
      };
    }

    document.getElementById('new-ap-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const obj = buildApObjectFromForm();
      // optional: warn on duplicate, but still allow generation
      // (duplicate warning UI already shown via input handlers)
      const jsonSnippet = JSON.stringify(obj, null, 2);
      const output = document.getElementById('output');
      output.value = jsonSnippet;
      output.focus();
      output.select();
    });

    document.getElementById('open-issue-btn').addEventListener('click', function () {
      // Make sure we at least have vendor + model so the user isn't totally lost
      const obj = buildApObjectFromForm();
      if (!obj.vendor || !obj.model) {
        alert('Please fill in at least Vendor and Model, then click "Generate JSON Snippet" before opening the GitHub form.');
        return;
      }
      // Soft gate on duplicates
      const isDup = existingSlugSet.has(makeSlug(obj.vendor, obj.model));
      if (isDup && !confirm('This AP appears to already exist. Open the new AP issue anyway?')) {
        return;
      }

      // Open the New AP Issue Form
      const url = `https://github.com/${encodeURIComponent(GITHUB_USER)}/${encodeURIComponent(GITHUB_REPO)}/issues/new?template=new_ap.yml`;
      window.open(url, '_blank', 'noopener');
    });

  </script>
</body>
</html>
