<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feature Finder (Preview) | Enterprise AP Comparison Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Card-based vendor selection */
    .vendor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      margin: 32px 0;
    }

    .vendor-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-base) var(--ease-out);
      position: relative;
    }

    .vendor-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .vendor-card.selected {
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .vendor-logo {
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 2rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
    }

    .vendor-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
    }

    .vendor-card.selected .vendor-name {
      color: rgba(255, 255, 255, 0.9);
    }

    .vendor-checkmark {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.5);
      transition: all var(--transition-base) var(--ease-out);
    }

    .vendor-card.selected .vendor-checkmark {
      opacity: 1;
      transform: scale(1);
    }

    .vendor-checkmark svg {
      width: 14px;
      height: 14px;
      stroke: white;
      stroke-width: 3;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .preview-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    @media (max-width: 640px) {
      .vendor-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 400px) {
      .vendor-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="preview-badge">PREVIEW MODE</div>
  <div class="container">
    <div class="header-with-logo">
      <h1><a href="index.html">Feature Finder (Preview)</a></h1>
      <img src="logo.png" alt="Enterprise AP Comparison Database" class="site-logo" />
    </div>

    <div class="actions">
      <a class="btn-link" href="index.html">Back to Comparison Table</a>
      <a class="btn-link" href="finder.html">View Standard Finder</a>
      <a class="btn-link" href="submit.html">Submit New AP</a>
      <button id="clear-filters" type="button" class="btn-link">Reset Filters</button>
      <button id="export-csv" type="button" class="btn-link">Export CSV</button>
    </div>

    <div class="card finder-card">
      <div class="badge">Preview</div>
      <div class="finder-grid">
        <section class="filter-panel">
          <div class="wizard-steps">
            <div class="step" id="step-wifi">
              <div class="step-number">1</div>
              <div class="step-label">Wi-Fi Generation</div>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step-vendors">
              <div class="step-number">2</div>
              <div class="step-label">Vendors</div>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step-form">
              <div class="step-number">3</div>
              <div class="step-label">Form Factor</div>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step-results">
              <div class="step-number">4</div>
              <div class="step-label">Results</div>
            </div>
          </div>
          <h2>Filters</h2>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Wi-Fi Generation</h3>
            </div>
            <div id="wifi-options" class="chip-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Vendor</h3>
            </div>
            <div id="vendor-options" class="vendor-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Form Factor</h3>
            </div>
            <div id="form-options" class="chip-grid"></div>
          </div>

          <div class="filter-group">
            <div class="filter-group-head">
              <h3>Antenna Type</h3>
            </div>
            <div id="antenna-options" class="chip-grid"></div>
          </div>
        </section>

        <section class="results-panel">
          <div class="results-header">
            <div>
              <h2>Results</h2>
              <p class="results-note" id="results-note">Loading data…</p>
            </div>
            <div class="match-count" id="match-count">—</div>
          </div>
          <div class="results-counter" id="results-counter" style="display:none;">
            <div class="counter-content">
              <span class="counter-number" id="counter-number">0</span>
              <span class="counter-label">APs match your criteria</span>
            </div>
          </div>

          <div id="active-filters" class="active-filters" style="display:none;"></div>

          <div id="results" class="results-table">
            <div class="result-row result-header">
              <div class="result-cell"></div>
              <div class="result-cell">Vendor</div>
              <div class="result-cell">Model</div>
              <div class="result-cell">Wi-Fi Generation</div>
              <div class="result-cell">Spatial Streams</div>
              <div class="result-cell">Antenna</div>
              <div class="result-cell">Form Factor</div>
              <div class="result-cell">MSRP</div>
              <div class="result-cell"></div>
            </div>
          </div>
          <div id="empty-state" class="empty-state" style="display:none;">
            <p>No APs match every selected requirement.</p>
            <p>Try removing one filter at a time to widen the results.</p>
          </div>
        </section>
      </div>
    </div>

    <div id="floating-compare" class="floating-compare" style="display:none;">
      <button id="compare-btn">Compare Selected (<span id="compare-count">0</span>)</button>
    </div>
  </div>

  <script>
    const DATA_URL = 'ap_data.json';
    let enrichedData = [];
    const selectedIds = new Set();

    const state = {
      wifi: new Set(),
      vendors: new Set(),
      antenna: new Set(),
      form: new Set()
    };

    const wifiOptions = [
      { id: 'wifi6', value: 'Wi-Fi 6', label: 'Wi-Fi 6' },
      { id: 'wifi6e', value: 'Wi-Fi 6E', label: 'Wi-Fi 6E' },
      { id: 'wifi7', value: 'Wi-Fi 7', label: 'Wi-Fi 7' }
    ];

    function deriveAntennaCategory(value) {
      const text = String(value || '').toLowerCase();
      if (!text) return 'Other';
      if (text.includes('internal')) return 'Internal';
      if (text.includes('external')) return 'External';
      if (text.includes('directional')) return 'Directional';
      return 'Other';
    }

    function slugify(value) {
      return String(value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function slugFor(entry) {
      return slugify(`${entry.vendor || ''}-${entry.model || ''}`);
    }

    function escapeAttrValue(value) {
      if (window.CSS && typeof window.CSS.escape === 'function') {
        return window.CSS.escape(value);
      }
      return String(value).replace(/"/g, '\\"');
    }

    function buildFilterOptions() {
      // Wi-Fi options (chip-based)
      const wifiContainer = document.getElementById('wifi-options');
      wifiContainer.innerHTML = '';
      wifiOptions.forEach(option => {
        const id = `wifi-${option.id}`;
        const label = document.createElement('label');
        label.className = 'chip-option';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.dataset.filterType = 'wifi';
        input.dataset.filterValue = option.value;
        input.addEventListener('change', () => toggleSelection('wifi', option.value, input.checked));
        const span = document.createElement('span');
        span.textContent = option.label;
        label.appendChild(input);
        label.appendChild(span);
        wifiContainer.appendChild(label);
      });

      // Vendor options (card-based)
      const vendorOptions = collectUniqueValues('vendor').map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderVendorCards('vendor-options', vendorOptions);

      // Form and antenna options (chip-based)
      const formValues = collectUniqueValues('form_factor').map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderCheckboxGroup('form-options', formValues, 'form');

      const antennaValues = Array.from(
        new Set(
          enrichedData
            .map(entry => entry._antennaCategory)
            .filter(label => label && label !== 'Other')
        )
      ).sort();
      const antennaOptions = antennaValues.map(label => ({
        id: slugify(label),
        value: label,
        label
      }));
      renderCheckboxGroup('antenna-options', antennaOptions, 'antenna');

      document.getElementById('results-note').textContent = 'Add filters to see matching APs.';
    }

    function renderVendorCards(targetId, options) {
      const container = document.getElementById(targetId);
      container.innerHTML = '';
      options.forEach(option => {
        const card = document.createElement('div');
        card.className = 'vendor-card';
        card.dataset.vendor = option.value;
        if (state.vendors.has(option.value)) {
          card.classList.add('selected');
        }

        const logo = document.createElement('div');
        logo.className = 'vendor-logo';
        logo.textContent = option.label.charAt(0).toUpperCase();
        card.appendChild(logo);

        const name = document.createElement('div');
        name.className = 'vendor-name';
        name.textContent = option.label;
        card.appendChild(name);

        const checkmark = document.createElement('div');
        checkmark.className = 'vendor-checkmark';
        checkmark.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>';
        card.appendChild(checkmark);

        card.addEventListener('click', () => {
          const isSelected = state.vendors.has(option.value);
          toggleSelection('vendors', option.value, !isSelected);
          card.classList.toggle('selected', !isSelected);
        });

        container.appendChild(card);
      });
    }

    function renderCheckboxGroup(targetId, options, type) {
      const container = document.getElementById(targetId);
      container.innerHTML = '';
      options.forEach(option => {
        const id = `${type}-${option.id || slugify(option.value || option.label)}`;
        const label = document.createElement('label');
        label.className = 'chip-option';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.dataset.filterType = type;
        input.dataset.filterValue = option.value || option.id;
        input.addEventListener('change', () => toggleSelection(type, input.dataset.filterValue, input.checked));
        const span = document.createElement('span');
        span.textContent = option.label;
        label.appendChild(input);
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    function collectUniqueValues(key) {
      const set = new Set();
      enrichedData.forEach(entry => {
        const value = (entry[key] || '').trim();
        if (value) set.add(value);
      });
      return Array.from(set).sort((a, b) => a.localeCompare(b));
    }

    function toggleSelection(type, value, checked) {
      const targetSet = state[type];
      if (!targetSet) return;
      if (checked) targetSet.add(value);
      else targetSet.delete(value);
      applyFilters();
    }

    function updateWizardSteps() {
      const hasWifi = state.wifi.size > 0;
      const hasVendors = state.vendors.size > 0;
      const hasForm = state.form.size > 0 || state.antenna.size > 0;
      
      const wifiStep = document.getElementById('step-wifi');
      const vendorsStep = document.getElementById('step-vendors');
      const formStep = document.getElementById('step-form');
      const resultsStep = document.getElementById('step-results');
      
      [wifiStep, vendorsStep, formStep, resultsStep].forEach(s => {
        s.classList.remove('active', 'completed');
      });
      
      if (hasWifi) {
        wifiStep.classList.add('completed');
        if (hasVendors) {
          vendorsStep.classList.add('completed');
          if (hasForm) {
            formStep.classList.add('completed');
            resultsStep.classList.add('active');
          } else {
            formStep.classList.add('active');
          }
        } else {
          vendorsStep.classList.add('active');
        }
      } else {
        wifiStep.classList.add('active');
      }
    }

    function applyFilters() {
      if (!enrichedData.length) return;
      const matches = enrichedData.filter(entry => matchesFilters(entry));
      renderActiveFilters();
      renderResults(matches);
      updateMatchCount(matches.length);
      updateResultsCounter(matches.length);
      updateWizardSteps();
      document.getElementById('results-note').textContent = matches.length
        ? 'Showing APs that meet every selected requirement.'
        : 'No matches yet — broaden your filters.';
    }

    function updateResultsCounter(count) {
      const counter = document.getElementById('results-counter');
      const counterNumber = document.getElementById('counter-number');
      
      if (count > 0) {
        counter.style.display = 'block';
        counterNumber.style.transform = 'scale(1.2)';
        setTimeout(() => {
          counterNumber.textContent = count;
          counterNumber.style.transform = 'scale(1)';
        }, 150);
      } else {
        counter.style.display = 'none';
      }
    }

    function matchesFilters(entry) {
      if (state.wifi.size) {
        for (const need of state.wifi) {
          if (!entry._wifiFlags.has(need)) return false;
        }
      }
      if (state.vendors.size) {
        if (!state.vendors.has(entry.vendor)) return false;
      }
      if (state.antenna.size) {
        const cat = entry._antennaCategory || 'Other';
        if (!state.antenna.has(cat)) return false;
      }
      if (state.form.size) {
        if (!state.form.has(entry.form_factor)) return false;
      }
      return true;
    }

    function renderActiveFilters() {
      const container = document.getElementById('active-filters');
      const chips = [];

      function pushChips(type, set, labelFn) {
        set.forEach(value => {
          chips.push({ type, value, label: labelFn ? labelFn(value) : value });
        });
      }

      pushChips('wifi', state.wifi, value => {
        const option = wifiOptions.find(opt => opt.value === value);
        return option ? option.label : value;
      });
      pushChips('vendors', state.vendors);
      pushChips('antenna', state.antenna);
      pushChips('form', state.form);

      if (!chips.length) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      chips.forEach(chip => {
        const btn = document.createElement('button');
        btn.className = 'filter-chip';
        btn.textContent = chip.label;
        btn.addEventListener('click', () => {
          toggleSelection(chip.type, chip.value, false);
          if (chip.type === 'vendors') {
            const card = document.querySelector(`[data-vendor="${chip.value}"]`);
            if (card) card.classList.remove('selected');
          }
        });
        container.appendChild(btn);
      });
    }

    function renderResults(matches) {
      const container = document.getElementById('results');
      const emptyState = document.getElementById('empty-state');
      
      if (matches.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      emptyState.style.display = 'none';

      const header = container.querySelector('.result-header');
      container.innerHTML = '';
      container.appendChild(header);

      matches.forEach(entry => {
        const row = document.createElement('div');
        row.className = 'result-row';

        const checkbox = document.createElement('div');
        checkbox.className = 'result-cell';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'row-select';
        cb.checked = selectedIds.has(entry._slug);
        cb.addEventListener('change', () => {
          if (cb.checked) selectedIds.add(entry._slug);
          else selectedIds.delete(entry._slug);
          updateCompareFab();
        });
        checkbox.appendChild(cb);
        row.appendChild(checkbox);

        const vendor = document.createElement('div');
        vendor.className = 'result-cell result-vendor';
        vendor.textContent = entry.vendor || '';

        const model = document.createElement('div');
        model.className = 'result-cell result-model';
        const modelLink = document.createElement('a');
        modelLink.href = `ap.html?id=${encodeURIComponent(entry._slug)}`;
        modelLink.textContent = entry.model || '';
        model.appendChild(modelLink);

        const wifi = document.createElement('div');
        wifi.className = 'result-cell result-wifi';
        wifi.textContent = entry.wifi_gen_radios || '';

        const spatial = document.createElement('div');
        spatial.className = 'result-cell result-spatial';
        spatial.textContent = entry.spatial_streams || '—';

        const antenna = document.createElement('div');
        antenna.className = 'result-cell result-antenna';
        antenna.textContent = entry._antennaCategory || entry.antenna_type || '—';

        const form = document.createElement('div');
        form.className = 'result-cell result-form';
        form.textContent = entry.form_factor || '—';

        const msrp = document.createElement('div');
        msrp.className = 'result-cell result-msrp';
        msrp.textContent = entry.msrp || '—';

        const actions = document.createElement('div');
        actions.className = 'result-cell result-actions';
        const datasheetLink = document.createElement('a');
        if (entry.datasheet_url) {
          datasheetLink.href = entry.datasheet_url;
          datasheetLink.target = '_blank';
          datasheetLink.rel = 'noopener noreferrer';
          datasheetLink.className = 'btn-link btn-link-ghost btn-link-small';
          datasheetLink.textContent = 'Datasheet';
          actions.appendChild(datasheetLink);
        }

        row.appendChild(checkbox);
        row.appendChild(vendor);
        row.appendChild(model);
        row.appendChild(wifi);
        row.appendChild(spatial);
        row.appendChild(antenna);
        row.appendChild(form);
        row.appendChild(msrp);
        row.appendChild(actions);

        row.style.cursor = 'pointer';
        row.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox' && e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
            const filterState = getFilterStateForUrl();
            const urlParams = new URLSearchParams();
            urlParams.set('id', entry._slug);
            urlParams.set('from', 'finder');
            if (filterState) {
              const filterParams = new URLSearchParams(filterState);
              filterParams.forEach((value, key) => urlParams.set(key, value));
            }
            window.location.href = `ap.html?${urlParams.toString()}`;
          }
        });

        container.appendChild(row);
      });

      updateCompareFab();
    }

    function getFilterStateForUrl() {
      const params = new URLSearchParams();
      if (state.wifi.size) params.set('wifi', Array.from(state.wifi).join(','));
      if (state.vendors.size) params.set('vendors', Array.from(state.vendors).join(','));
      if (state.antenna.size) params.set('antenna', Array.from(state.antenna).join(','));
      if (state.form.size) params.set('form', Array.from(state.form).join(','));
      return params.toString();
    }

    function updateMatchCount(count) {
      document.getElementById('match-count').textContent = count > 0 ? `${count} matches` : '—';
    }

    function updateCompareFab() {
      const fab = document.getElementById('floating-compare');
      const countEl = document.getElementById('compare-count');
      if (selectedIds.size >= 2) {
        fab.style.display = 'flex';
        countEl.textContent = selectedIds.size;
      } else {
        fab.style.display = 'none';
      }
    }

    function clearAllFilters() {
      state.wifi.clear();
      state.vendors.clear();
      state.antenna.clear();
      state.form.clear();
      document.querySelectorAll('.chip-option input').forEach(cb => cb.checked = false);
      document.querySelectorAll('.vendor-card').forEach(card => card.classList.remove('selected'));
      applyFilters();
    }

    function exportToCsv() {
      if (!enrichedData.length) return;
      const matches = enrichedData.filter(entry => matchesFilters(entry));
      if (matches.length === 0) {
        alert('No APs to export. Please adjust your filters.');
        return;
      }
      const headers = ['Vendor', 'Model', 'Wi-Fi Generation', 'Spatial Streams', 'Antenna', 'Form Factor', 'MSRP'];
      const rows = matches.map(entry => [
        entry.vendor || '',
        entry.model || '',
        entry.wifi_gen_radios || '',
        entry.spatial_streams || '',
        entry._antennaCategory || entry.antenna_type || '',
        entry.form_factor || '',
        entry.msrp || ''
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(v => {
        const s = String(v);
        const needs = /[\",\\n]/.test(s);
        return needs ? '\"' + s.replace(/\"/g, '\"\"') + '\"' : s;
      }).join(','))].join('\\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ap-finder-preview.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function loadData() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        enrichedData = data.map(entry => {
          const slug = slugFor(entry);
          const wifiFlags = new Set();
          const wifiText = String(entry.wifi_gen_radios || '').toLowerCase();
          if (wifiText.includes('wi-fi 6') && !wifiText.includes('6e') && !wifiText.includes('7')) wifiFlags.add('Wi-Fi 6');
          if (wifiText.includes('wi-fi 6e') || wifiText.includes('6e')) wifiFlags.add('Wi-Fi 6E');
          if (wifiText.includes('wi-fi 7') || wifiText.includes('7')) wifiFlags.add('Wi-Fi 7');
          return {
            ...entry,
            _slug: slug,
            _wifiFlags: wifiFlags,
            _antennaCategory: deriveAntennaCategory(entry.antenna_type)
          };
        });
        buildFilterOptions();
        applyFilters();
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('results-note').textContent = 'Failed to load AP data.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const header = document.querySelector('.header-with-logo');
      if (header) {
        window.addEventListener('scroll', () => {
          if (window.scrollY > 10) {
            header.classList.add('scrolled');
          } else {
            header.classList.remove('scrolled');
          }
        });
      }
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      const exportBtn = document.getElementById('export-csv');
      if (exportBtn) {
        exportBtn.addEventListener('click', exportToCsv);
      }
      const compareBtn = document.getElementById('compare-btn');
      if (compareBtn) {
        compareBtn.addEventListener('click', () => {
          if (selectedIds.size < 2) return;
          const idsParam = Array.from(selectedIds).join(',');
          window.location.href = `compare-preview.html?ids=${encodeURIComponent(idsParam)}`;
        });
      }
      loadData();
      updateWizardSteps();
    });
  </script>
</body>
</html>

